{$SERVER_NAME}{$SERVER_NAME_EXTRA} {
	handle /api/* {
		uri strip_prefix /api
		reverse_proxy api:3000
	}

	log

	# test
	{$CADDY_SERVER_EXTRA_DIRECTIVES}

	root * /srv/app/dist

	rewrite /results* /
	rewrite /projects* /
	rewrite /analyses* /
	rewrite /login* /
	rewrite /help* /
	rewrite /orgs* /
	rewrite /org* /
	rewrite /signup* /
	rewrite /password_reset_request* /
	rewrite /email_action* /
	rewrite /settings* /
	rewrite /auth* /
	rewrite /404* /

	encode zstd gzip
	file_server
}

{$SERVER_NAME}:15672 {
	reverse_proxy rabbitmq:15672
}

{$SERVER_NAME}:8080 {
	log
	reverse_proxy adminer:8080
}

{$SERVER_NAME}:9091 {
	log
	reverse_proxy prometheus:9090
}

{$SERVER_NAME}:3001 {
	log
	reverse_proxy grafana:3000
}

# Metrics endpoint for monitoring
:2019 {
	metrics /metrics
}
